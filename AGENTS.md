# ESP32 BMS Monitor - Agent Instructions

This file contains instructions for AI agents working on the ESP32 BMS Monitor project.

Before any of the build/flash commands, ensure that the ESP-IDF environment is set up correctly.
Source the export script here to set it up for whichever shell
fish: . /Users/adamrunner/esp/v5.5/esp-idf/export.fish
bash/zsh: . /Users/adamrunner/esp/v5.5/esp-idf/export.sh
Build/Flash
- Build: idf.py build
- Upload: idf.py flash
- Monitor: idf.py monitor
- Clean: idf.py clean

These commands can be chained together in a single idf.py call, e.g. idf.py build flash monitor

Code style
- Language: C++ (ESP-IDF). Mirror patterns in main/main.cpp and existing sources.
- Imports: angle brackets for ESP-IDF/SDK headers (freertos/…, driver/…, esp_log.h, esp_timer.h); quotes for project headers (include/, components/). Use C standard headers with .h names (<stdio.h>, <string.h>, <stdint.h>) as needed; do not use <stdio>. If choosing C++ wrappers (<cstdio>, <cstdint>, <cstring>) in C++ sources, qualify with std:: and keep usage consistent.
- Include order: C/C++ standard headers first, then ESP-IDF/SDK headers, then project headers. Remove unused includes.
- C/C++ interop: Headers for C libraries in components/ that are included from C++ must have extern "C" guards to avoid name mangling.
- Formatting: 4-space indentation; braces on next line as in repo; ~100 char line length; keep includes grouped and ordered.
- Types: prefer fixed-width integer types from <stdint.h> in both C and C++ sources; in C++ you may alternatively use <cstdint> with std::uintXX_t. Avoid magic literals; use const and constexpr where applicable.
- Naming: UPPER_SNAKE_CASE for macros/log TAGs; lower_snake_case for vars/functions (e.g., ws2812 led_strip_instance); PascalCase reserved for library types.
- Error handling: check return values; log with ESP_LOGx using TAG; early-return on failures; avoid printf for errors; prefer ESP_LOGE.
- Concurrency: use FreeRTOS APIs from correct context; vTaskDelay(pdMS_TO_TICKS(ms)); avoid busy loops and long critical sections.
- Memory: avoid dynamic allocation in hot paths; prefer stack/static; free resources in error paths.
- Build config: sdkconfig
- Cursor/Copilot rules: none present (.cursor/rules, .cursorrules, .github/copilot-instructions.md not found). If added later, mirror key points here.
- SPIFFS filesystem is where credentials are stored, see data directory

Repository conventions
- Keep main/CMakeLists.txt minimal (idf_component_register only); CMake auto-generated by ESP-IDF.
- Component CMakeLists.txt files in components/ directories should only contain idf_component_register.
- Do not commit secrets (sdkconfig, upload ports), use SPIFFS or NVS for config or sensitive information.
- Configuration files in data/ directory are flashed to SPIFFS for runtime configuration.

Project Structure
- main/: Main application code (main.cpp, sntp_manager.cpp)
- include/: Global header files (bms_interface.h, bms_snapshot.h, sntp_manager.h)
- components/: Reusable components with their own CMakeLists.txt
  - daly_bms/: Daly BMS driver (C interface)
  - jbd_bms/: JBD BMS driver (C interface)
  - device_id/: Device identification system (eFUSE MAC or custom ID)
  - logging/: Modular logging system with multiple sinks and serializers
  - wifi_manager/: WiFi connection management with credential storage
- data/: Configuration files flashed to SPIFFS (wifi_config.txt, mqtt_config.txt, device_config.txt)
- examples/: Reference implementations and protocol documentation

Device Identification
- Each ESP32 device has a unique device_id included in all telemetry data
- Device ID sources (priority order):
  1. Custom ID from /spiffs/device_config.txt (e.g., "solar-bms-1")
  2. ESP32 chip eFUSE MAC address (format: "bms-A1B2C3D4E5F6")
- Device ID requirements: alphanumeric, hyphen, underscore; max 32 chars
- Device ID is included in all serialized output (JSON, CSV) as the first field
- MQTT client ID automatically uses device_id for unique identification
- Component location: components/device_id/

Logging System
- Use LOG_INIT(), LOG_SEND(), LOG_SHUTDOWN() macros from log_manager.h
- Configure logging via JSON string with multiple sinks (serial, mqtt, tcp, udp, http)
- Serializers support multiple formats (JSON, CSV, XML, human-readable)
- BMS data uses BMSSnapshot struct from bms_snapshot.h
- All telemetry includes device_id as first field for multi-BMS deployments

WiFi and Connectivity
- WiFi credentials managed via wifi_manager component
- Configuration stored in SPIFFS (/spiffs/wifi_config.txt)
- MQTT support through logging system
  - Device-specific topics: bms/telemetry/{device_id} (configurable via use_device_topic)
  - Wildcard subscription for all devices: bms/telemetry/#
  - Legacy single-topic mode available (use_device_topic=false)
- SNTP time synchronization for real timestamps
